require('dotenv').config();
const oracledb = require('oracledb');
const path = require('path');

/**
 * WordTest Academy - Complete Database Schema Setup
 * 모든 필요한 테이블을 생성하는 통합 스크립트
 */

async function setupAllTables() {
    let connection;

    try {
        const walletPath = path.join(__dirname, 'wallet');
        process.env.TNS_ADMIN = walletPath;

        console.log('=== WordTest Academy DB Setup ===');
        console.log('Connecting to Oracle Database...');

        connection = await oracledb.getConnection({
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD,
            connectString: process.env.DB_CONNECT_STRING,
            configDir: walletPath,
            walletLocation: walletPath,
            walletPassword: process.env.DB_WALLET_PASSWORD
        });

        console.log('✅ Connected to Oracle Database\n');

        // 1. Student Curriculums Table
        console.log('[1/4] Creating student_curriculums table...');
        try {
            await connection.execute(`
                CREATE TABLE student_curriculums (
                    id VARCHAR2(50) PRIMARY KEY,
                    student_id VARCHAR2(50) NOT NULL,
                    curriculum_id VARCHAR2(50) NOT NULL,
                    title VARCHAR2(200) NOT NULL,
                    days NUMBER NOT NULL,
                    start_date DATE NOT NULL,
                    schedule CLOB NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    CONSTRAINT fk_student_curriculum FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
                )
            `);
            console.log('   ✅ student_curriculums table created.');
        } catch (err) {
            if (err.errorNum === 955) {
                console.log('   ⚠️  student_curriculums table already exists.');
            } else {
                throw err;
            }
        }

        // Index for student_curriculums
        try {
            await connection.execute(`CREATE INDEX idx_student_curriculums_student ON student_curriculums(student_id)`);
            console.log('   ✅ Index created.');
        } catch (err) {
            if (err.errorNum !== 955) console.error('   ⚠️  Index error:', err.message);
        }

        // 2. Listening Tests Table
        console.log('\n[2/4] Creating listening_tests table...');
        try {
            await connection.execute(`
                CREATE TABLE listening_tests (
                    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    teacher_id VARCHAR2(50),
                    level_num NUMBER,
                    topic VARCHAR2(200),
                    question_count NUMBER,
                    questions_json CLOB,
                    audio_url VARCHAR2(500),
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            `);
            console.log('   ✅ listening_tests table created.');
        } catch (err) {
            if (err.errorNum === 955) {
                console.log('   ⚠️  listening_tests table already exists.');
            } else {
                throw err;
            }
        }

        // Index for listening_tests
        try {
            await connection.execute(`CREATE INDEX idx_tests_teacher ON listening_tests(teacher_id)`);
            console.log('   ✅ Index created.');
        } catch (err) {
            if (err.errorNum !== 955) console.error('   ⚠️  Index error:', err.message);
        }

        // 3. Test Assignments Table
        console.log('\n[3/4] Creating test_assignments table...');
        try {
            await connection.execute(`
                CREATE TABLE test_assignments (
                    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                    test_id NUMBER REFERENCES listening_tests(id) ON DELETE CASCADE,
                    student_id VARCHAR2(50),
                    status VARCHAR2(20) DEFAULT 'assigned',
                    score NUMBER,
                    answers_json CLOB,
                    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    completed_at TIMESTAMP
                )
            `);
            console.log('   ✅ test_assignments table created.');
        } catch (err) {
            if (err.errorNum === 955) {
                console.log('   ⚠️  test_assignments table already exists.');
            } else {
                throw err;
            }
        }

        // Index for test_assignments
        try {
            await connection.execute(`CREATE INDEX idx_assignments_student ON test_assignments(student_id)`);
            console.log('   ✅ Index created.');
        } catch (err) {
            if (err.errorNum !== 955) console.error('   ⚠️  Index error:', err.message);
        }

        // 4. Student Progress Table (for Class Log)
        console.log('\n[4/4] Creating student_progress table...');
        try {
            await connection.execute(`
                CREATE TABLE student_progress (
                    id VARCHAR2(50) PRIMARY KEY,
                    student_id VARCHAR2(50) NOT NULL,
                    curriculum_id VARCHAR2(50) NOT NULL,
                    current_day NUMBER DEFAULT 0,
                    completed_days NUMBER DEFAULT 0,
                    last_study_date DATE,
                    progress_data CLOB,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    CONSTRAINT fk_student_progress FOREIGN KEY (student_id) REFERENCES users(id) ON DELETE CASCADE
                )
            `);
            console.log('   ✅ student_progress table created.');
        } catch (err) {
            if (err.errorNum === 955) {
                console.log('   ⚠️  student_progress table already exists.');
            } else {
                throw err;
            }
        }

        // Index for student_progress
        try {
            await connection.execute(`CREATE INDEX idx_student_progress_student ON student_progress(student_id)`);
            console.log('   ✅ Index created.');
        } catch (err) {
            if (err.errorNum !== 955) console.error('   ⚠️  Index error:', err.message);
        }

        console.log('\n=== ✅ Database Setup Completed! ===\n');

        // Verify tables
        console.log('Verifying tables...');
        const result = await connection.execute(
            `SELECT table_name FROM user_tables WHERE table_name IN ('STUDENT_CURRICULUMS', 'LISTENING_TESTS', 'TEST_ASSIGNMENTS', 'STUDENT_PROGRESS') ORDER BY table_name`,
            [],
            { outFormat: oracledb.OUT_FORMAT_OBJECT }
        );

        console.log('\nCreated tables:');
        result.rows.forEach(row => {
            console.log(`  ✓ ${row.TABLE_NAME}`);
        });

    } catch (err) {
        console.error('\n❌ Error setting up database:', err);
        throw err;
    } finally {
        if (connection) {
            try {
                await connection.close();
                console.log('\n✅ Database connection closed.');
            } catch (err) {
                console.error('Error closing connection:', err);
            }
        }
    }
}

// Run setup
setupAllTables()
    .then(() => {
        console.log('\n✅ Setup completed successfully!');
        process.exit(0);
    })
    .catch((err) => {
        console.error('\n❌ Setup failed:', err);
        process.exit(1);
    });
